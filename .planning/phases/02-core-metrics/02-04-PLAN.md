---
phase: 02-core-metrics
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/core/metrics/coverage.ts
  - src/core/metrics/coverage.test.ts
autonomous: true

must_haves:
  truths:
    - "Node.js projects report coverage percentage via c8/nyc"
    - "Python projects report coverage percentage via pytest-cov/coverage"
    - "Go projects report coverage percentage via go test -cover"
    - "Missing coverage tool returns graceful failure"
  artifacts:
    - path: "src/core/metrics/coverage.ts"
      provides: "Test coverage measurement"
      exports: ["measureCoverage", "COVERAGE_TOOLS"]
    - path: "src/core/metrics/coverage.test.ts"
      provides: "Tests for coverage"
      min_lines: 30
  key_links:
    - from: "coverage.ts"
      to: "runner.ts"
      via: "runTool import"
      pattern: "import.*runTool.*from.*runner"
---

<objective>
Implement test coverage measurement across languages.

Purpose: Enable BTAR to report test coverage percentage for detected languages.
Output: measureCoverage function that runs appropriate coverage tool and parses percentage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-metrics/02-01-SUMMARY.md

@src/core/types.ts
@src/core/metrics/types.ts
@src/core/metrics/runner.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Coverage Tool Mapping</name>
  <files>src/core/metrics/coverage.ts</files>
  <action>
Create coverage measurement:

1. COVERAGE_TOOLS constant mapping SupportedLanguage → tool info:
   - typescript: { tool: "c8", command: ["npx", "c8", "--reporter=text-summary", "npm", "test"], parseCoverage: fn }
     (alternative: vitest --coverage if vitest project)
   - javascript: { tool: "c8", command: ["npx", "c8", "--reporter=text-summary", "npm", "test"], parseCoverage: fn }
   - python: { tool: "pytest-cov", command: ["pytest", "--cov=.", "--cov-report=term-missing"], parseCoverage: fn }
     (alternative: coverage run -m pytest && coverage report)
   - go: { tool: "go test", command: ["go", "test", "-cover", "./..."], parseCoverage: fn }
   - java: { tool: "jacoco", command: ["mvn", "test", "jacoco:report"], parseCoverage: fn } (complex, optional)
   - swift: { tool: "swift test", command: ["swift", "test", "--enable-code-coverage"], parseCoverage: fn }
   - kotlin: { tool: "jacoco", command: ["./gradlew", "test", "jacocoTestReport"], parseCoverage: fn }
   - ruby: { tool: "simplecov", command: ["bundle", "exec", "rspec", "--format", "progress"], parseCoverage: fn }
   - php: { tool: "phpunit", command: ["phpunit", "--coverage-text"], parseCoverage: fn }

2. Coverage parsing functions per tool:
   - c8/nyc: Parse "All files" line, extract percentage (e.g., "All files | 85.5 |")
   - pytest-cov: Parse "TOTAL" line, extract percentage
   - go test -cover: Parse "coverage: XX.X% of statements"
   - Others: Look for percentage patterns like "XX.X%" or "XX%"

3. measureCoverage function:
   ```typescript
   async function measureCoverage(
     language: SupportedLanguage,
     directory: string
   ): Promise<MetricResult>
   ```
   - Look up tool for language
   - Run tool via runTool (may take longer, use extended timeout)
   - Parse output for coverage percentage
   - Return MetricResult with value as percentage (0-100)

4. Handle edge cases:
   - No tests exist → tool may report 0% or error
   - Tests fail → still try to report coverage if available
   - Tool not installed → success: false, value: -1
   - Coverage not configured → try to run anyway

5. Timeout consideration:
   - Coverage runs tests, which can be slow
   - Use 120000ms (2 min) timeout instead of default 60s
  </action>
  <verify>npm run build succeeds</verify>
  <done>measureCoverage exported, handles priority languages (TS/JS, Python, Go)</done>
</task>

<task type="auto">
  <name>Task 2: Add Coverage Tests</name>
  <files>src/core/metrics/coverage.test.ts</files>
  <action>
Create tests for coverage:

1. Test COVERAGE_TOOLS mapping:
   - typescript has c8 tool
   - python has pytest-cov tool
   - go has go test tool

2. Test coverage parsing functions (unit tests):
   - Parse sample c8 output: "All files | 85.5 | 90.2 | 78.3 | 85.5 |"
   - Parse sample pytest-cov output: "TOTAL ... 85%"
   - Parse sample go test output: "coverage: 72.5% of statements"

3. Test measureCoverage behavior (mock runner):
   - Mock runTool to return sample output
   - Verify correct percentage extracted
   - Verify 0-100 range enforced

Pattern: Use vitest, test parsing with realistic tool output samples
  </action>
  <verify>npm test passes</verify>
  <done>Tests cover tool mapping, percentage parsing, and measureCoverage logic</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm test` passes
- [ ] measureCoverage handles: typescript, javascript, python, go
- [ ] Percentage parsing tested with sample output
- [ ] Extended timeout for coverage runs implemented
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Priority languages covered (TS/JS, Python, Go)
- Percentage values correctly normalized to 0-100
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-metrics/02-04-SUMMARY.md`
</output>
