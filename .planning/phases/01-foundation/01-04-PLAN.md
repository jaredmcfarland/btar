---
phase: 01-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - src/cli.ts
  - src/commands/analyze.ts
  - src/core/progress.ts
autonomous: true
must_haves:
  truths:
    - "User can run btar --help and see usage"
    - "User can run btar analyze . and see detected languages"
    - "User sees progress output during analysis"
    - "User sees error message for invalid directory"
  artifacts:
    - path: "src/commands/analyze.ts"
      provides: "Analyze command implementation"
      exports: ["analyzeCommand"]
      min_lines: 40
    - path: "src/core/progress.ts"
      provides: "Progress output utilities"
      exports: ["createProgressReporter"]
      min_lines: 20
    - path: "src/cli.ts"
      provides: "CLI entry with analyze command"
      contains: "analyzeCommand"
  key_links:
    - from: "cli.ts"
      to: "analyzeCommand"
      via: "command registration"
      pattern: 'command.*"analyze"'
    - from: "analyze.ts"
      to: "loadConfig"
      via: "config loading"
      pattern: "loadConfig"
    - from: "analyze.ts"
      to: "detectLanguages"
      via: "language detection"
      pattern: "detectLanguages"
    - from: "analyze.ts"
      to: "progress"
      via: "progress reporting"
      pattern: "createProgressReporter|progress"
---

<objective>
Wire CLI, analyze command, and progress output into working end-to-end flow.

Purpose: Complete Phase 1 by integrating all pieces into functional CLI.
Output: Working `btar analyze .` command that detects languages and shows progress.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Requirements:**
- INFRA-01: User can run BTAR from command line with `btar` command
- INFRA-07: User sees progress output during analysis

**Dependencies from prior plans:**
- 01-01: package.json, tsconfig.json, src/cli.ts stub
- 01-02: loadConfig(), DEFAULT_CONFIG, BTARConfig
- 01-03: detectLanguages(), LANGUAGE_MARKERS

**CLI flow:**
```
btar analyze <directory>
  → Load config from directory/.btar.yaml
  → Show "Analyzing <directory>..."
  → Detect languages
  → Show "Found: python, typescript"
  → Exit 0
```

**Progress output style:**
- Minimal, clean output
- Use symbols: ✓ success, ✗ error, → progress
- Color optional (detect TTY)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progress reporter utility</name>
  <files>src/core/progress.ts</files>
  <action>
    Create progress.ts with:

    1. ProgressReporter interface:
       - start(message: string): void
       - success(message: string): void
       - error(message: string): void
       - info(message: string): void

    2. createProgressReporter(options?: { quiet?: boolean }):
       - Returns object implementing ProgressReporter
       - Uses console.log with symbols (✓ ✗ →)
       - If quiet=true, suppress non-error output
       - Detect TTY for color support (process.stdout.isTTY)

    3. Export symbols as constants for testing

    AVOID: Complex spinner libraries (ora, etc.) - keep simple.
    WHY: Phase 1 is foundation; fancy spinners can come later if needed.
  </action>
  <verify>
    - File compiles without errors
    - createProgressReporter().success("test") outputs "✓ test"
  </verify>
  <done>
    - progress.ts exports createProgressReporter
    - Reporter outputs clean, symbol-prefixed messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement analyze command</name>
  <files>src/commands/analyze.ts</files>
  <action>
    Create analyze.ts with:

    1. Import loadConfig from ../core/config
    2. Import detectLanguages from ../core/detector
    3. Import createProgressReporter from ../core/progress

    4. analyzeCommand function:
       ```typescript
       export async function analyzeCommand(directory: string, options: AnalyzeOptions): Promise<void> {
         const progress = createProgressReporter({ quiet: options.quiet });

         // Validate directory exists
         if (!existsSync(directory)) {
           progress.error(`Directory not found: ${directory}`);
           process.exit(1);
         }

         progress.start(`Analyzing ${resolve(directory)}...`);

         // Load config
         const config = await loadConfig(directory);

         // Detect languages
         const languages = await detectLanguages(directory, config);

         if (languages.length === 0) {
           progress.info("No supported languages detected");
           return;
         }

         progress.success(`Found: ${languages.map(l => l.name).join(", ")}`);
       }
       ```

    5. Export AnalyzeOptions interface:
       - quiet?: boolean
       - config?: string (path to config file, future use)

    AVOID: Implementing metrics collection here - that's Phase 2.
    WHY: This plan completes Phase 1 foundation only.
  </action>
  <verify>
    - File compiles without errors
    - Import statements resolve correctly
  </verify>
  <done>
    - analyzeCommand exports and compiles
    - Function loads config, detects languages, reports progress
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire analyze command into CLI</name>
  <files>src/cli.ts</files>
  <action>
    Update src/cli.ts:

    1. Import analyzeCommand from ./commands/analyze

    2. Replace placeholder command with real implementation:
       ```typescript
       program
         .command("analyze <directory>")
         .description("Analyze codebase for agent-readiness")
         .option("-q, --quiet", "Suppress progress output")
         .option("-c, --config <path>", "Path to config file")
         .action(async (directory, options) => {
           await analyzeCommand(directory, options);
         });
       ```

    3. Add error handling:
       ```typescript
       program.parseAsync(process.argv).catch((error) => {
         console.error("Error:", error.message);
         process.exit(1);
       });
       ```

    4. Ensure shebang is present: #!/usr/bin/env node
  </action>
  <verify>
    - npm run build succeeds
    - node dist/cli.js --help shows "analyze" command
    - node dist/cli.js analyze . runs without error (assuming in a JS/TS project)
    - node dist/cli.js analyze /nonexistent shows error message
  </verify>
  <done>
    - btar analyze <dir> runs end-to-end
    - Help shows analyze command with options
    - Invalid directory produces clear error
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] node dist/cli.js --help shows program info with analyze command
- [ ] node dist/cli.js analyze . outputs detected languages
- [ ] node dist/cli.js analyze /nonexistent outputs error message
- [ ] node dist/cli.js analyze . --quiet suppresses progress
- [ ] All Phase 1 success criteria from ROADMAP.md satisfied
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Phase 1 requirements satisfied:
  - INFRA-01: `btar` command works
  - INFRA-02: Language detection works for target languages
  - INFRA-04: Config loading works (tested in 01-02)
  - INFRA-07: Progress output displays
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
