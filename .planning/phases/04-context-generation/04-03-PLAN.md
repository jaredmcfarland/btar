---
phase: 04-context-generation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/core/context/claude-hooks.ts, src/core/context/claude-hooks.test.ts]
autonomous: true

must_haves:
  truths:
    - "generateClaudeHooks returns valid JSON matching Claude Code schema"
    - "Generated hooks include PreToolUse validation for file writes"
    - "Hooks can be written to .claude/settings.json structure"
  artifacts:
    - path: "src/core/context/claude-hooks.ts"
      provides: "Claude Code hooks generation"
      exports: ["generateClaudeHooks", "ClaudeHooksConfig"]
    - path: "src/core/context/claude-hooks.test.ts"
      provides: "Test coverage"
      min_lines: 50
  key_links:
    - from: "generateClaudeHooks"
      to: "JSON structure"
      via: "matches Claude Code hooks schema"
      pattern: "PreToolUse|PostToolUse"
---

<objective>
Implement Claude Code hooks generator for BTAR validation.

Purpose: Generate .claude/settings.json hooks configuration that runs BTAR validation before/after code changes. Claude Code hooks enable automated quality checks during AI-assisted development.
Output: Claude Code hooks generator producing valid settings.json structure.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Claude Code hooks schema reference:
# {
#   "hooks": {
#     "PreToolUse": [
#       {
#         "matcher": "Edit|Write",
#         "hooks": [{ "type": "command", "command": "..." }]
#       }
#     ],
#     "PostToolUse": [...]
#   }
# }
#
# Hook input includes: session_id, tool_name, tool_input, tool_use_id
# Hook output can include: continue, stopReason, systemMessage
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Claude hooks types and schema</name>
  <files>src/core/context/claude-hooks.ts</files>
  <action>
    Create src/core/context/ directory if it doesn't exist.

    Define types matching Claude Code hooks schema:
    - ClaudeHook = { type: "command", command: string }
    - ClaudeHookEntry = { matcher: string, hooks: ClaudeHook[] }
    - ClaudeHooksConfig = { hooks: { PreToolUse?: ClaudeHookEntry[], PostToolUse?: ClaudeHookEntry[] } }

    Create generateClaudeHooks(options: ClaudeHooksOptions): ClaudeHooksConfig

    ClaudeHooksOptions = {
      projectPath: string
      enablePreCommit?: boolean  // Run lint/type checks before writes
      enablePostCommit?: boolean // Run BTAR score after changes
      customCommands?: string[]  // Additional commands to run
    }

    Default hooks to generate:
    - PreToolUse on Edit|Write: Run type checker for affected files
    - PostToolUse on Edit|Write: Run linter, update BTAR score

    Commands should use `btar analyze --json` for machine-readable output.
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Types defined, basic generator structure in place</done>
</task>

<task type="auto">
  <name>Task 2: Implement hooks generator with tests</name>
  <files>src/core/context/claude-hooks.ts, src/core/context/claude-hooks.test.ts</files>
  <action>
    Complete generateClaudeHooks implementation:

    1. Build PreToolUse hooks:
       - Matcher: "Edit|MultiEdit|Write"
       - Command: runs type checker on changed file (uses $BTAR_PROJECT_PATH or cwd)

    2. Build PostToolUse hooks:
       - Matcher: "Edit|MultiEdit|Write"
       - Command: runs `btar analyze . --json` and checks score

    3. Return ClaudeHooksConfig object

    Add helper: formatAsSettingsJson(config: ClaudeHooksConfig): string
    - Returns JSON string ready to write to .claude/settings.json
    - Uses 2-space indentation

    Write tests covering:
    - Default options produce valid hooks structure
    - Custom commands are included
    - Output JSON is parseable
    - Matcher regex is valid
  </action>
  <verify>npm test -- src/core/context/claude-hooks.test.ts passes</verify>
  <done>Generator produces valid Claude Code hooks, tests pass</done>
</task>

</tasks>

<verification>
- [ ] npm run build succeeds
- [ ] npm test passes all claude-hooks tests
- [ ] Generated JSON matches Claude Code hooks schema
- [ ] formatAsSettingsJson output is valid JSON
</verification>

<success_criteria>
- All tasks completed
- Hooks generator produces valid Claude Code configuration
- Tests verify schema compliance
- Generated hooks can be written to settings.json
</success_criteria>

<output>
After completion, create `.planning/phases/04-context-generation/04-03-SUMMARY.md`
</output>
