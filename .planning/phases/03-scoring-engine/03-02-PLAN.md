---
phase: 03-scoring-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/output.ts
  - src/commands/analyze.ts
autonomous: true
must_haves:
  truths:
    - "Running with --json flag produces valid JSON to stdout"
    - "JSON output includes all metrics and summary data"
    - "Non-JSON output continues to work as before"
  artifacts:
    - path: "src/core/output.ts"
      provides: "JSON serialization for analysis results"
      exports: ["AnalysisOutput", "formatAsJson"]
  key_links:
    - from: "src/commands/analyze.ts"
      to: "src/core/output.ts"
      via: "import formatAsJson"
      pattern: "import.*formatAsJson.*from.*output"
---

<objective>
Add JSON output format for integration with other tools.

Purpose: INFRA-05 - Users need machine-readable output for CI and tooling.
Output: --json flag on analyze command, AnalysisOutput type.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files to modify
@src/commands/analyze.ts
@src/core/metrics/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create output types and formatters</name>
  <files>src/core/output.ts</files>
  <action>
    Create AnalysisOutput type that is JSON-serializable:
    - languages: Array of { language, confidence, markers }
    - metrics: Object with typeStrictness, lintErrors, coverage (each with per-language results)
    - summary: Object with totalTypeErrors, totalLintErrors, averageCoverage

    Note: Maps cannot be JSON.stringify'd directly. Convert MetricsReport Maps to plain objects.

    Create formatAsJson(report: MetricsReport): string function:
    - Convert Maps to objects
    - Return JSON.stringify with 2-space indent
  </action>
  <verify>npm run build succeeds, no type errors</verify>
  <done>output.ts exports AnalysisOutput type and formatAsJson function</done>
</task>

<task type="auto">
  <name>Task 2: Add --json flag to analyze command</name>
  <files>src/commands/analyze.ts</files>
  <action>
    Add json flag to AnalyzeOptions interface:
    - json?: boolean

    Modify analyzeCommand:
    - Add .option('-j, --json', 'Output results as JSON') to CLI
    - If options.json is true:
      - Import formatAsJson from ../core/output.js
      - Call formatAsJson(report) and console.log the result
      - Skip all progress.* calls (quiet output)
      - Return early after JSON output
    - Existing text output remains unchanged for non-JSON mode
  </action>
  <verify>
    npm run build succeeds
    Run: node dist/cli.js analyze . --json | jq . (should be valid JSON)
  </verify>
  <done>btar analyze --json outputs valid JSON to stdout</done>
</task>

</tasks>

<verification>
- [ ] npm run build succeeds
- [ ] btar analyze . --json produces valid JSON
- [ ] btar analyze . (without --json) produces same text output as before
- [ ] JSON contains languages, metrics, and summary fields
</verification>

<success_criteria>
- All tasks completed
- JSON output is valid and parseable
- Existing text output unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-scoring-engine/03-02-SUMMARY.md`
</output>
