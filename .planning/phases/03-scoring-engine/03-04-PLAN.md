---
phase: 03-scoring-engine
plan: 04
type: execute
wave: 2
depends_on: ["03-02", "03-03"]
files_modified:
  - .github/workflows/btar.yml
  - src/commands/init-ci.ts
  - src/cli.ts
autonomous: true
must_haves:
  truths:
    - "User can run btar init-ci to generate GitHub Actions workflow"
    - "Generated workflow runs btar analyze with --json and --fail-under"
    - "Workflow file is valid GitHub Actions YAML"
  artifacts:
    - path: "src/commands/init-ci.ts"
      provides: "CI workflow generator command"
      exports: ["initCiCommand"]
    - path: ".github/workflows/btar.yml"
      provides: "Example/template GitHub Actions workflow"
  key_links:
    - from: "src/cli.ts"
      to: "src/commands/init-ci.ts"
      via: "command registration"
      pattern: "import.*initCiCommand"
---

<objective>
Create GitHub Actions integration for running BTAR in CI pipelines.

Purpose: INFRA-03 - Users need easy CI setup for automated quality gates.
Output: init-ci command that generates .github/workflows/btar.yml
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans this depends on
@.planning/phases/03-scoring-engine/03-02-SUMMARY.md
@.planning/phases/03-scoring-engine/03-03-SUMMARY.md

# CLI structure
@src/cli.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create init-ci command</name>
  <files>src/commands/init-ci.ts</files>
  <action>
    Create InitCiOptions interface:
    - threshold?: number (default 70)
    - force?: boolean (overwrite existing)

    Create initCiCommand function:
    - Check if .github/workflows/btar.yml exists
    - If exists and not force, warn and exit
    - Create .github/workflows directory if needed (use fs.mkdirSync with recursive: true)
    - Write btar.yml workflow file

    Workflow template (as string):
    ```yaml
    name: BTAR Analysis

    on:
      push:
        branches: [main, master]
      pull_request:
        branches: [main, master]

    jobs:
      analyze:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '20'

          - name: Install BTAR
            run: npm install -g btar

          - name: Run Analysis
            run: btar analyze . --json --fail-under ${threshold}

          - name: Upload Results
            if: always()
            uses: actions/upload-artifact@v4
            with:
              name: btar-report
              path: btar-report.json
    ```

    Replace ${threshold} with options.threshold (default 70).

    Output success message with path to created file.
  </action>
  <verify>npm run build succeeds</verify>
  <done>init-ci.ts creates GitHub Actions workflow file</done>
</task>

<task type="auto">
  <name>Task 2: Register init-ci command in CLI</name>
  <files>src/cli.ts</files>
  <action>
    Import initCiCommand from ./commands/init-ci.js

    Add command to program:
    ```
    program
      .command('init-ci')
      .description('Generate GitHub Actions workflow for BTAR')
      .option('-t, --threshold <score>', 'Minimum score threshold', '70')
      .option('-f, --force', 'Overwrite existing workflow')
      .action(async (options) => {
        await initCiCommand({
          threshold: parseInt(options.threshold, 10),
          force: options.force
        });
      });
    ```
  </action>
  <verify>
    npm run build succeeds
    node dist/cli.js init-ci --help shows command
  </verify>
  <done>btar init-ci command registered and functional</done>
</task>

<task type="auto">
  <name>Task 3: Create example workflow in repo</name>
  <files>.github/workflows/btar.yml</files>
  <action>
    Create .github/workflows directory if it doesn't exist.

    Create btar.yml as a working example for this repo itself:
    - Use threshold of 50 (since this is a work-in-progress)
    - Add comment explaining it's a self-test

    This serves as both documentation and validation that the workflow syntax is correct.
  </action>
  <verify>
    cat .github/workflows/btar.yml shows valid YAML
    GitHub Actions linter (if available) validates syntax
  </verify>
  <done>Example workflow exists in repo</done>
</task>

</tasks>

<verification>
- [ ] npm run build succeeds
- [ ] btar init-ci creates .github/workflows/btar.yml
- [ ] btar init-ci --threshold 80 uses custom threshold
- [ ] btar init-ci --force overwrites existing file
- [ ] Generated YAML is valid GitHub Actions syntax
</verification>

<success_criteria>
- All tasks completed
- init-ci command generates valid workflow
- Example workflow in repo
</success_criteria>

<output>
After completion, create `.planning/phases/03-scoring-engine/03-04-SUMMARY.md`
</output>
