---
phase: 05-remediation
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/core/remediation/ratchet.ts
  - src/core/remediation/ratchet.test.ts
autonomous: true

must_haves:
  truths:
    - "Score can be persisted to .btar-score file"
    - "Persisted score can be loaded for comparison"
    - "Regression detected when current score < persisted score"
    - "New baseline can be saved explicitly"
  artifacts:
    - path: "src/core/remediation/ratchet.ts"
      provides: "Ratchet mode score persistence and comparison"
      exports: ["loadRatchetScore", "saveRatchetScore", "checkRatchetRegression", "RatchetState"]
    - path: "src/core/remediation/ratchet.test.ts"
      provides: "TDD test coverage for ratchet mode"
      min_lines: 80
  key_links:
    - from: "checkRatchetRegression"
      to: "ScoreResult"
      via: "compares current score to baseline"
      pattern: "ScoreResult"
    - from: "saveRatchetScore"
      to: ".btar-score"
      via: "writes JSON to file"
      pattern: "writeFile.*btar-score"
---

<objective>
Implement ratchet mode for preventing score regressions using TDD.

Purpose: Enable CI enforcement of "never go backwards" - once a score is achieved, regressions fail the build.
Output: Ratchet state management functions with full test coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/scoring.ts
</context>

<feature>
  <name>Ratchet Mode Score Persistence</name>
  <files>src/core/remediation/ratchet.ts, src/core/remediation/ratchet.test.ts</files>
  <behavior>
    RatchetState interface:
    - score: number (baseline score)
    - timestamp: string (ISO date when saved)
    - breakdown: ScoreResult["breakdown"] (for debugging)

    Functions:
    - loadRatchetScore(directory: string) → RatchetState | null
      Returns null if .btar-score doesn't exist or is invalid

    - saveRatchetScore(directory: string, scoreResult: ScoreResult) → void
      Writes .btar-score with current score as new baseline

    - checkRatchetRegression(current: ScoreResult, baseline: RatchetState) → RatchetResult
      Returns { passed: boolean, message: string, delta: number }

    Cases:
    - No .btar-score file → loadRatchetScore returns null
    - Current 75, baseline 70 → passed: true, delta: +5
    - Current 65, baseline 70 → passed: false, delta: -5, message: "Score regression: 65 < 70"
    - Current 70, baseline 70 → passed: true, delta: 0
  </behavior>
  <implementation>
    1. Define RatchetState and RatchetResult interfaces
    2. Implement loadRatchetScore with JSON parsing and validation
    3. Implement saveRatchetScore with JSON serialization
    4. Implement checkRatchetRegression with comparison logic
    5. Handle edge cases: missing file, invalid JSON, negative scores
  </implementation>
</feature>

<verification>
- npm test -- ratchet passes all tests
- npm run build succeeds
- Exports are available from src/core/remediation/index.ts
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactor complete if needed
- 2-3 TDD commits present
- All ratchet state operations work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/05-remediation/05-02-SUMMARY.md`
</output>
