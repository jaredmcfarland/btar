---
phase: 05-remediation
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/commands/analyze.ts
  - src/cli.ts
  - src/core/output.ts
  - src/core/remediation/index.ts
autonomous: true

must_haves:
  truths:
    - "Analyze output includes recommendations section"
    - "Recommendations appear in both text and JSON output"
    - "--ratchet flag enforces no regression from .btar-score"
    - "--save-baseline saves current score to .btar-score"
  artifacts:
    - path: "src/commands/analyze.ts"
      provides: "Analyze command with recommendations and ratchet integration"
      contains: "generateRecommendations|checkRatchetRegression"
    - path: "src/core/output.ts"
      provides: "Output formatting with recommendations"
      contains: "recommendations"
    - path: "src/core/remediation/index.ts"
      provides: "Re-exports all remediation modules"
      exports: ["generateRecommendations", "loadRatchetScore", "saveRatchetScore", "checkRatchetRegression", "runFix"]
  key_links:
    - from: "analyze.ts"
      to: "generateRecommendations"
      via: "imports and calls"
      pattern: "import.*generateRecommendations"
    - from: "analyze.ts"
      to: "checkRatchetRegression"
      via: "imports and calls when --ratchet"
      pattern: "import.*checkRatchetRegression"
---

<objective>
Integrate recommendations and ratchet mode into the analyze command.

Purpose: Surface recommendations to users and enforce ratchet mode in CI.
Output: Enhanced analyze command with recommendations and ratchet support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-remediation/05-01-SUMMARY.md
@.planning/phases/05-remediation/05-02-SUMMARY.md
@src/commands/analyze.ts
@src/core/output.ts
@src/core/scoring.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create remediation barrel export</name>
  <files>src/core/remediation/index.ts</files>
  <action>
    Create index.ts that re-exports all remediation modules:

    ```typescript
    export { generateRecommendations } from "./recommendations.js";
    export type { Recommendation, RecommendationTier } from "./recommendations.js";

    export { loadRatchetScore, saveRatchetScore, checkRatchetRegression } from "./ratchet.js";
    export type { RatchetState, RatchetResult } from "./ratchet.js";

    export { runFix, FIX_TOOLS } from "./fixer.js";
    export type { FixResult } from "./fixer.js";
    ```

    This enables clean imports: `import { generateRecommendations, checkRatchetRegression } from "./core/remediation/index.js"`
  </action>
  <verify>npm run build succeeds, imports work from barrel</verify>
  <done>Barrel export created for remediation module</done>
</task>

<task type="auto">
  <name>Task 2: Add recommendations to analyze output</name>
  <files>src/commands/analyze.ts, src/core/output.ts</files>
  <action>
    In analyze.ts:
    1. Import generateRecommendations from remediation
    2. After calculateScore, call generateRecommendations(scoreResult, report)
    3. Pass recommendations to output formatters

    In output.ts:
    1. Add recommendations field to AnalysisOutput interface
    2. Add recommendations to JSON output
    3. Update formatAsJson to include recommendations array

    Text output format:
    ```
    Recommendations:
      P0: Fix 12 type errors (run: tsc --noEmit to see errors)
      P1: Fix 5 lint errors (run: eslint . --fix)
      P2: Increase test coverage from 45% to 70%+
    ```

    JSON output adds:
    ```json
    {
      "recommendations": [
        { "tier": "P0", "category": "type-strictness", "message": "...", "tool": "tsc" },
        ...
      ]
    }
    ```
  </action>
  <verify>btar analyze . shows recommendations, btar analyze . --json includes recommendations array</verify>
  <done>Recommendations visible in both text and JSON output</done>
</task>

<task type="auto">
  <name>Task 3: Add ratchet mode to analyze command</name>
  <files>src/commands/analyze.ts, src/cli.ts</files>
  <action>
    Add CLI options in cli.ts:
    ```typescript
    .option("--ratchet", "Enforce no regression from .btar-score baseline")
    .option("--save-baseline", "Save current score as new baseline")
    ```

    Add to AnalyzeOptions interface:
    ```typescript
    ratchet?: boolean;
    saveBaseline?: boolean;
    ```

    In analyzeCommand:
    1. If --save-baseline: call saveRatchetScore after scoring
    2. If --ratchet:
       a. Load baseline with loadRatchetScore
       b. If baseline exists, check regression with checkRatchetRegression
       c. If regression detected, exit(1) with error message
       d. If no baseline, warn user to run with --save-baseline first

    Error message format:
    ```
    ✗ Ratchet failed: Score 65 is below baseline 70 (Δ-5)
      Run with --save-baseline to update baseline after fixing issues.
    ```
  </action>
  <verify>
    - btar analyze . --save-baseline creates .btar-score
    - btar analyze . --ratchet passes when score >= baseline
    - btar analyze . --ratchet exits 1 when score < baseline
  </verify>
  <done>Ratchet mode fully integrated into analyze command</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] npm test passes
- [ ] btar analyze . shows recommendations section
- [ ] btar analyze . --json includes recommendations array
- [ ] btar analyze . --save-baseline creates .btar-score file
- [ ] btar analyze . --ratchet checks against baseline
</verification>

<success_criteria>
- All tasks completed
- Recommendations visible in analyze output
- Ratchet mode enforces no regression
- JSON output includes all new fields
</success_criteria>

<output>
After completion, create `.planning/phases/05-remediation/05-04-SUMMARY.md`
</output>
